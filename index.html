<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Qui Browser - Lightweight VR-optimized web browser with enterprise-grade security">
    <meta name="keywords" content="VR browser, Meta Quest, Pico, WebXR, lightweight browser, PWA">
    <meta name="author" content="Qui Browser Team">
    <meta name="theme-color" content="#0052cc">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Qui Browser">
    <title>Qui Browser - VR-Optimized Web Browser</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" href="/assets/icons/icon-192.png">
    <link rel="apple-touch-icon" href="/assets/icons/icon-192.png">

    <!-- Critical CSS (inline for fastest rendering) -->
    <style>
        :root {
            --color-background: #f4f5f7;
            --color-surface: #ffffff;
            --color-text: #172b4d;
            --color-text-subtle: #6b778c;
            --color-border: #dfe1e6;
            --color-primary: #0052cc;
            --color-success: #00875a;
            --color-warning: #ff991f;
            --color-danger: #de350b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* VR Mode Indicator */
        .vr-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            background: rgba(0, 82, 204, 0.9);
            color: white;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            display: none;
        }

        .vr-indicator.active {
            display: block;
        }
    </style>

    <!-- Async CSS Loading -->
    <link rel="preload" href="/assets/styles/design-system.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/assets/styles/design-system.css"></noscript>

    <!-- Performance optimizations -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests; default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https:; frame-src 'self'; base-uri 'self'; form-action 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=(self)">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2>Qui Browser</h2>
            <p>Initializing VR Environment...</p>
        </div>
    </div>

    <!-- VR Mode Indicator -->
    <div id="vr-indicator" class="vr-indicator">
        VR Mode Active
    </div>

    <!-- Main Application Container -->
    <div id="app" class="app-container hidden">
        <!-- Navigation Bar -->
        <nav class="nav-bar" role="navigation" aria-label="Main navigation">
            <div class="nav-left">
                <button id="back-btn" class="nav-btn" aria-label="Go back">‚Üê</button>
                <button id="forward-btn" class="nav-btn" aria-label="Go forward">‚Üí</button>
                <button id="refresh-btn" class="nav-btn" aria-label="Refresh page">‚ü≥</button>
            </div>
            <div class="nav-center">
                <input type="text" id="url-bar" class="url-bar" placeholder="Enter URL or search..." aria-label="URL bar">
            </div>
            <div class="nav-right">
                <button id="vr-toggle" class="nav-btn vr-btn" aria-label="Toggle VR mode">ü•Ω</button>
                <button id="settings-btn" class="nav-btn" aria-label="Settings">‚öôÔ∏è</button>
                <button id="menu-btn" class="nav-btn" aria-label="Menu">‚ò∞</button>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main id="main-content" class="main-content" role="main">
            <div id="browser-view" class="browser-view">
                <!-- Dynamic content loads here -->
            </div>
        </main>

        <!-- VR Canvas (hidden initially) -->
        <canvas id="vr-canvas" class="vr-canvas hidden"></canvas>

        <!-- Settings Panel (hidden initially) -->
        <aside id="settings-panel" class="settings-panel hidden" role="complementary" aria-label="Settings">
            <h2>Settings</h2>
            <div class="settings-content">
                <!-- Settings will be dynamically loaded -->
            </div>
        </aside>
    </div>

    <!-- Error Notification (hidden initially) -->
    <div id="error-notification" class="error-notification hidden" role="alert">
        <!-- Error messages will appear here -->
    </div>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.info('Service Worker registered'))
                .catch(err => console.warn('Service Worker registration failed:', err));
        }
    </script>

    <!-- Critical JavaScript (inline for immediate execution) -->
    <script>
        // Performance monitoring start
        window.performanceStartTime = performance.now();

        // Browser capability detection
        window.browserCapabilities = {
            webxr: 'xr' in navigator,
            webgl: !!document.createElement('canvas').getContext('webgl2'),
            wasm: typeof WebAssembly !== 'undefined',
            serviceWorker: 'serviceWorker' in navigator,
            webAudio: 'AudioContext' in window || 'webkitAudioContext' in window
        };

        // Module loader configuration
        window.moduleLoader = {
            loaded: new Set(),
            pending: new Map(),

            async load(modules) {
                const promises = [];
                for (const module of modules) {
                    if (!this.loaded.has(module) && !this.pending.has(module)) {
                        const promise = this.loadModule(module);
                        this.pending.set(module, promise);
                        promises.push(promise);
                    } else if (this.pending.has(module)) {
                        promises.push(this.pending.get(module));
                    }
                }
                return Promise.all(promises);
            },

            async loadModule(module) {
                const script = document.createElement('script');
                script.src = `/assets/js/${module}.js`;
                script.async = true;

                return new Promise((resolve, reject) => {
                    script.onload = () => {
                        this.loaded.add(module);
                        this.pending.delete(module);
                        resolve();
                    };
                    script.onerror = () => {
                        this.pending.delete(module);
                        reject(new Error(`Failed to load module: ${module}`));
                    };
                    document.head.appendChild(script);
                });
            }
        };

        // Progressive loading strategy
        async function initializeApp() {
            try {
                // Phase 1: Critical modules (unified systems)
                await window.moduleLoader.load([
                    'unified-performance-system',
                    'unified-security-system',
                    'unified-error-handler'
                ]);

                // Phase 2: Core functionality
                await window.moduleLoader.load([
                    'ui-components',
                    'accessibility',
                    'mobile-pwa'
                ]);

                // Remove loading screen
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.style.opacity = '0';
                    setTimeout(() => {
                        loadingScreen.classList.add('hidden');
                        document.getElementById('app').classList.remove('hidden');
                    }, 500);
                }

                // Phase 3: VR modules (lazy load on demand)
                if (window.browserCapabilities.webxr) {
                    // Load VR modules when VR is requested
                    document.getElementById('vr-toggle')?.addEventListener('click', async () => {
                        if (!window.vrModulesLoaded) {
                            await loadVRModules();
                            window.vrModulesLoaded = true;
                        }
                        toggleVRMode();
                    });
                }

                // Phase 4: Enhancement modules (background)
                requestIdleCallback(() => {
                    loadEnhancementModules();
                });

                // Performance measurement
                const loadTime = performance.now() - window.performanceStartTime;
                console.info(`App initialized in ${loadTime.toFixed(2)}ms`);

            } catch (error) {
                console.error('Failed to initialize app:', error);
                showErrorMessage('Failed to initialize application. Please reload.');
            }
        }

        // VR modules loader
        async function loadVRModules() {
            const vrModules = [
                'unified-vr-extension-system',
                'vr-launcher',
                'vr-navigation',
                'vr-hand-tracking',
                'vr-spatial-audio',
                'vr-gesture-controls'
            ];

            console.info('Loading VR modules...');
            await window.moduleLoader.load(vrModules);
            console.info('VR modules loaded');
        }

        // Enhancement modules loader
        async function loadEnhancementModules() {
            const enhancementModules = [
                'cross-platform-optimizer',
                'ux-enhancer',
                'plugin-system'
            ];

            try {
                await window.moduleLoader.load(enhancementModules);
                console.info('Enhancement modules loaded');
            } catch (error) {
                console.warn('Some enhancement modules failed to load:', error);
            }
        }

        // VR mode toggle
        function toggleVRMode() {
            if (!window.xrSession) {
                startVRSession();
            } else {
                endVRSession();
            }
        }

        // Start VR session
        async function startVRSession() {
            if (!navigator.xr) {
                showErrorMessage('WebXR not supported on this device');
                return;
            }

            try {
                const session = await navigator.xr.requestSession('immersive-vr', {
                    requiredFeatures: ['local-floor'],
                    optionalFeatures: ['bounded-floor', 'hand-tracking']
                });

                window.xrSession = session;
                document.getElementById('vr-indicator').classList.add('active');

                // Initialize VR
                if (window.VRLauncher) {
                    window.VRLauncher.initialize(session);
                }

            } catch (error) {
                console.error('Failed to start VR session:', error);
                showErrorMessage('Failed to enter VR mode');
            }
        }

        // End VR session
        async function endVRSession() {
            if (window.xrSession) {
                await window.xrSession.end();
                window.xrSession = null;
                document.getElementById('vr-indicator').classList.remove('active');
            }
        }

        // Error message display
        function showErrorMessage(message) {
            const notification = document.getElementById('error-notification');
            if (notification) {
                notification.textContent = message;
                notification.classList.remove('hidden');
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 5000);
            }
        }

        // Initialize on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Memory cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (window.xrSession) {
                window.xrSession.end();
            }

            // Clean up any active timers
            if (window.activeTimers) {
                window.activeTimers.forEach(timer => clearInterval(timer));
            }
        });

        // Handle visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Pause non-critical operations
                if (window.unifiedPerformance) {
                    window.unifiedPerformance.pause();
                }
            } else {
                // Resume operations
                if (window.unifiedPerformance) {
                    window.unifiedPerformance.resume();
                }
            }
        });
    </script>

    <!-- Three.js (loaded only when VR is activated) -->
    <script>
        window.loadThreeJS = async function() {
            if (!window.THREE) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.min.js';
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }
        };
    </script>
</body>
</html>