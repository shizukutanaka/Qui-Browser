name: Qui Browser VR WebAssembly CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'wasm/**'
      - 'assets/js/wasm/**'
      - '.github/workflows/wasm-build.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'wasm/**'
      - 'assets/js/wasm/**'

env:
  CARGO_TERM_COLOR: always
  NODE_VERSION: '18'

jobs:
  # å“è³ªãƒã‚§ãƒƒã‚¯ã‚¸ãƒ§ãƒ–
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Check Rust formatting
        run: |
          cd wasm
          cargo fmt -- --check

      - name: Run Clippy
        run: |
          cd wasm
          cargo clippy -- -D warnings

      - name: Run Rust tests
        run: |
          cd wasm
          cargo test

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã‚¸ãƒ§ãƒ–
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: |
          cd wasm
          cargo audit

  # WebAssemblyãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–
  build-wasm:
    name: Build WebAssembly
    runs-on: ubuntu-latest
    needs: [quality-check, security-scan]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Add wasm-pack to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Create build directories
        run: mkdir -p wasm/build assets/js/wasm

      - name: Run WebAssembly build
        run: |
          cd wasm
          chmod +x build.sh
          ./build.sh

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-artifacts
          path: |
            assets/js/wasm/
            wasm/build/
          retention-days: 30

  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–
  performance-test:
    name: Performance Test
    runs-on: ubuntu-latest
    needs: build-wasm
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-artifacts
          path: .

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install performance testing tools
        run: npm install -g lighthouse

      - name: Create test HTML file
        run: |
          cat > test-wasm.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Qui Browser WASM Test</title>
          </head>
          <body>
              <h1>WebAssembly Performance Test</h1>
              <div id="test-results"></div>
              <script type="module">
                  import init from './assets/js/wasm/qui_browser_wasm.js';

                  async function runTests() {
                      const results = document.getElementById('test-results');

                      try {
                          const wasm = await init();
                          const start = performance.now();

                          // è¡Œåˆ—è¨ˆç®—ãƒ†ã‚¹ãƒˆ
                          const matrix1 = new Float32Array([1, 2, 3, 4]);
                          const matrix2 = new Float32Array([5, 6, 7, 8]);

                          for (let i = 0; i < 1000; i++) {
                              wasm.multiply_matrices(matrix1, matrix2);
                          }

                          const end = performance.now();
                          results.innerHTML = `<p>1000å›ã®è¡Œåˆ—è¨ˆç®—: ${end - start}ms</p>`;

                      } catch (error) {
                          results.innerHTML = `<p>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
                      }
                  }

                  runTests();
              </script>
          </body>
          </html>
          EOF

      - name: Run WebAssembly performance test
        run: node -e "
          const fs = require('fs');
          const jsFile = 'assets/js/wasm/qui_browser_wasm.js';
          const wasmFile = 'assets/js/wasm/qui_browser_wasm_bg.wasm';

          if (fs.existsSync(jsFile) && fs.existsSync(wasmFile)) {
              console.log('âœ… WebAssemblyãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ãƒ“ãƒ«ãƒ‰ã•ã‚Œã¦ã„ã¾ã™');
              console.log('ğŸ“Š JavaScriptã‚µã‚¤ã‚º:', fs.statSync(jsFile).size, 'bytes');
              console.log('ğŸ“Š WebAssemblyã‚µã‚¤ã‚º:', fs.statSync(wasmFile).size, 'bytes');
          } else {
              console.error('âŒ WebAssemblyãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              process.exit(1);
          }
        "

  # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–ï¼ˆãƒªãƒªãƒ¼ã‚¹æ™‚ã®ã¿ï¼‰
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: performance-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-artifacts
          path: .

      - name: Setup deployment configuration
        run: |
          echo "Deployment configuration for production"
          # å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã‚’ã“ã“ã«è¿½åŠ 

      - name: Deploy to CDN
        run: |
          echo "Deploying WebAssembly modules to CDN..."
          # å®Ÿéš›ã®CDNãƒ‡ãƒ—ãƒ­ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«è¿½åŠ 

  # é€šçŸ¥ã‚¸ãƒ§ãƒ–
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [quality-check, security-scan, build-wasm, performance-test]
    if: always()
    steps:
      - name: Notify build status
        run: |
          if [ "${{ needs.build-wasm.result }}" == "success" ]; then
            echo "âœ… WebAssemblyãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ã¾ã—ãŸ"
          else
            echo "âŒ WebAssemblyãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ"
          fi
