name: CD - Continuous Deployment

on:
  push:
    branches: [ main ]
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================================================
  # JOB 1: Build and Test
  # ============================================================================
  build:
    name: Build Production Assets
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build production
        run: npm run build
        env:
          NODE_ENV: production

      - name: Generate build info
        run: |
          echo "{
            \"version\": \"${{ github.ref_name }}\",
            \"commit\": \"${{ github.sha }}\",
            \"buildTime\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"branch\": \"${{ github.ref_name }}\"
          }" > dist/build-info.json

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: production-build
          path: dist/
          retention-days: 30

  # ============================================================================
  # JOB 2: Deploy to GitHub Pages
  # ============================================================================
  deploy-github-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 10

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: production-build
          path: dist

      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v2
        with:
          path: dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2

      - name: Deployment success
        run: |
          echo "âœ… Deployed to GitHub Pages: ${{ steps.deployment.outputs.page_url }}"

  # ============================================================================
  # JOB 3: Deploy to Netlify
  # ============================================================================
  deploy-netlify:
    name: Deploy to Netlify
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    timeout-minutes: 10

    environment:
      name: netlify-production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: production-build
          path: dist

      - name: Deploy to Netlify
        id: deploy
        uses: netlify/actions/cli@master
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        with:
          args: deploy --dir=dist --prod

      - name: Deployment success
        run: |
          echo "âœ… Deployed to Netlify: ${{ steps.deploy.outputs.url }}"

  # ============================================================================
  # JOB 4: Deploy to Vercel
  # ============================================================================
  deploy-vercel:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    timeout-minutes: 10

    environment:
      name: vercel-production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: production-build
          path: dist

      - name: Deploy to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: dist

      - name: Deployment success
        run: |
          echo "âœ… Deployed to Vercel: ${{ steps.deploy.outputs.url }}"

  # ============================================================================
  # JOB 5: Build and Push Docker Image
  # ============================================================================
  docker-build-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: [build]
    if: startsWith(github.ref, 'refs/tags/v')
    timeout-minutes: 30

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Docker image published
        run: |
          echo "âœ… Docker image published:"
          echo "${{ steps.meta.outputs.tags }}"

  # ============================================================================
  # JOB 6: Create GitHub Release
  # ============================================================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build, docker-build-push]
    if: startsWith(github.ref, 'refs/tags/v')
    timeout-minutes: 10

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: production-build
          path: dist

      - name: Create release archive
        run: |
          cd dist
          zip -r ../qui-browser-vr-${{ github.ref_name }}.zip .
          cd ..
          tar -czf qui-browser-vr-${{ github.ref_name }}.tar.gz -C dist .

      - name: Generate checksums
        run: |
          sha256sum qui-browser-vr-${{ github.ref_name }}.zip > checksums.txt
          sha256sum qui-browser-vr-${{ github.ref_name }}.tar.gz >> checksums.txt

      - name: Extract changelog
        id: changelog
        run: |
          VERSION=${{ github.ref_name }}
          awk "/## \[${VERSION}\]/,/## \[/" CHANGELOG.md | sed '1d;$d' > release-notes.md
          if [ ! -s release-notes.md ]; then
            echo "No changelog found for ${VERSION}" > release-notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release-notes.md
          files: |
            qui-browser-vr-${{ github.ref_name }}.zip
            qui-browser-vr-${{ github.ref_name }}.tar.gz
            checksums.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release created
        run: |
          echo "âœ… GitHub Release created: ${{ github.ref_name }}"

  # ============================================================================
  # JOB 7: Performance Verification
  # ============================================================================
  verify-performance:
    name: Verify Production Performance
    runs-on: ubuntu-latest
    needs: [deploy-github-pages]
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli

      - name: Run Lighthouse on deployed site
        run: |
          lhci autorun --collect.url=${{ needs.deploy-github-pages.outputs.url }} \
            --collect.numberOfRuns=3 \
            --assert.preset=lighthouse:recommended
        continue-on-error: true

      - name: Performance check complete
        run: |
          echo "âœ… Performance verification complete"

  # ============================================================================
  # JOB 8: Smoke Tests
  # ============================================================================
  smoke-tests:
    name: Production Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy-github-pages]
    timeout-minutes: 10

    steps:
      - name: Test homepage
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ needs.deploy-github-pages.outputs.url }})
          if [ $response -eq 200 ]; then
            echo "âœ… Homepage responding correctly"
          else
            echo "âŒ Homepage returned status: $response"
            exit 1
          fi

      - name: Test service worker
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ needs.deploy-github-pages.outputs.url }}/service-worker.js)
          if [ $response -eq 200 ]; then
            echo "âœ… Service worker available"
          else
            echo "âŒ Service worker not found"
            exit 1
          fi

      - name: Test build info
        run: |
          curl -s ${{ needs.deploy-github-pages.outputs.url }}/build-info.json | jq .
          echo "âœ… Build info accessible"

  # ============================================================================
  # JOB 9: Deployment Summary
  # ============================================================================
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-github-pages, deploy-netlify, deploy-vercel, docker-build-push, create-release]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Pages | ${{ needs.deploy-github-pages.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Netlify | ${{ needs.deploy-netlify.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Vercel | ${{ needs.deploy-vercel.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ needs.docker-build-push.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release | ${{ needs.create-release.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Notify deployment success
        if: |
          needs.deploy-github-pages.result == 'success' ||
          needs.deploy-netlify.result == 'success' ||
          needs.deploy-vercel.result == 'success'
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸš€ Qui Browser VR ${{ github.ref_name }} is now live!"

      - name: Notify deployment issues
        if: |
          needs.deploy-github-pages.result == 'failure' ||
          needs.deploy-netlify.result == 'failure' ||
          needs.deploy-vercel.result == 'failure'
        run: |
          echo "âŒ Some deployments failed. Please check the logs."
          exit 1
