<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qui Browser - リソース監視ダッシュボード</title>
  <style>
    :root {
      --color-surface: #ffffff;
      --color-surface-subtle: #f4f5f7;
      --color-background: #f4f5f7;
      --color-text: #172b4d;
      --color-text-subtle: #6b778c;
      --color-border: #dfe1e6;
      --color-border-strong: #b3bac5;
      --color-primary: #0052cc;
      --color-primary-hover: #0747a6;
      --color-success: #00875a;
      --color-warning: #ffab00;
      --color-danger: #de350b;
      --shadow-elevation:
        0 1px 1px rgba(9, 30, 66, 0.25),
        0 0 1px rgba(9, 30, 66, 0.31);
      --radius-md: 8px;
      --radius-lg: 12px;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --font-family: 'Segoe UI', 'Noto Sans JP', 'Roboto', sans-serif;
      --font-size-title: 1.75rem;
      --font-size-heading: 1.1rem;
      --font-size-subheading: 0.95rem;
      --font-size-body: 0.95rem;
      --font-size-caption: 0.85rem;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--color-background);
      color: var(--color-text);
      font-family: var(--font-family);
      line-height: 1.5;
    }

    .page-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .page-header {
      background: var(--color-surface);
      box-shadow: var(--shadow-elevation);
      padding: var(--spacing-md) var(--spacing-xl);
    }

    .page-header__content {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: var(--spacing-lg);
      justify-content: space-between;
      max-width: 1280px;
      margin: 0 auto;
    }

    .page-header__title-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }

    .page-title {
      font-size: var(--font-size-title);
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .page-subtitle {
      color: var(--color-text-subtle);
      font-size: var(--font-size-body);
    }

    .page-header__meta {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: var(--font-size-caption);
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      background: rgba(0, 82, 204, 0.1);
      color: var(--color-primary);
    }

    .badge--info { background: rgba(0, 82, 204, 0.1); color: var(--color-primary); }
    .badge--success { background: rgba(0, 135, 90, 0.12); color: var(--color-success); }
    .badge--warning { background: rgba(255, 171, 0, 0.16); color: #7f5f01; }
    .badge--danger { background: rgba(222, 53, 11, 0.12); color: var(--color-danger); }

    main {
      flex: 1;
      padding: var(--spacing-xl);
    }

    .layout-container {
      max-width: 1280px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    .status-panel {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-elevation);
      padding: var(--spacing-lg);
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-lg);
      justify-content: space-between;
      align-items: center;
    }

    .status-panel__primary {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      min-width: 240px;
    }

    .status-indicator {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      position: relative;
    }

    .status-indicator::after {
      content: '';
      position: absolute;
      inset: -8px;
      border-radius: 50%;
      border: 2px solid currentColor;
      opacity: 0.2;
    }

    .status-indicator--healthy { background: var(--color-success); color: var(--color-success); }
    .status-indicator--warning { background: var(--color-warning); color: var(--color-warning); }
    .status-indicator--critical { background: var(--color-danger); color: var(--color-danger); }

    .status-panel__details {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .status-panel__details .title {
      font-size: var(--font-size-heading);
      font-weight: 600;
    }

    .status-panel__details .subtitle {
      color: var(--color-text-subtle);
      font-size: var(--font-size-caption);
    }

    .status-panel__meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: var(--spacing-xs);
      min-width: 200px;
    }

    .status-panel__meta .label {
      color: var(--color-text-subtle);
      font-size: var(--font-size-caption);
    }

    .status-panel__meta .value {
      font-size: var(--font-size-body);
      font-weight: 600;
    }

    .grid {
      display: grid;
      gap: var(--spacing-lg);
    }

    .grid--three {
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .grid--two {
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    }

    .card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-elevation);
      padding: var(--spacing-lg);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-size: var(--font-size-heading);
      font-weight: 600;
      color: var(--color-text);
    }

    .card-meta {
      font-size: var(--font-size-caption);
      color: var(--color-text-subtle);
    }

    .card-value {
      font-size: 1.9rem;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    .card-subtitle {
      font-size: var(--font-size-caption);
      color: var(--color-text-subtle);
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: var(--color-surface-subtle);
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--color-success), #36b37e);
      transition: width 0.25s ease;
    }

    .progress-fill.is-warning { background: linear-gradient(90deg, #ffab00, #ffc400); }
    .progress-fill.is-critical { background: linear-gradient(90deg, #de350b, #ff5630); }

    .metrics-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .metrics-item {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding-bottom: var(--spacing-sm);
      border-bottom: 1px solid var(--color-border);
    }

    .metrics-item:last-child { border-bottom: none; }

    .metrics-label {
      font-size: var(--font-size-caption);
      color: var(--color-text-subtle);
    }

    .metrics-value {
      font-family: 'Roboto Mono', 'Courier New', monospace;
      font-size: var(--font-size-body);
      font-weight: 600;
      color: var(--color-text);
    }

    .alert-box {
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 171, 0, 0.4);
      background: rgba(255, 171, 0, 0.08);
      padding: var(--spacing-lg);
      display: none;
      box-shadow: var(--shadow-elevation);
    }

    .alert-box.show { display: block; }

    .alert-title {
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
      color: #7f5f01;
    }

    .alert-message div {
      font-size: var(--font-size-caption);
      color: var(--color-text);
      padding: 2px 0;
    }

    .error-message {
      background: rgba(222, 53, 11, 0.12);
      color: var(--color-danger);
      border: 1px solid rgba(222, 53, 11, 0.3);
      border-radius: var(--radius-lg);
      padding: var(--spacing-md);
      display: none;
    }

    .refresh-info {
      font-size: var(--font-size-caption);
      color: var(--color-text-subtle);
      text-align: center;
    }

    @media (max-width: 768px) {
      main {
        padding: var(--spacing-lg);
      }

      .page-header {
        padding: var(--spacing-md);
      }

      .page-header__content {
        gap: var(--spacing-md);
      }

      .status-panel {
        flex-direction: column;
        align-items: flex-start;
      }

      .status-panel__meta {
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="page-shell">
    <header class="page-header">
      <div class="page-header__content">
        <div class="page-header__title-group">
          <h1 class="page-title">Qui Browser 運用ダッシュボード</h1>
          <p class="page-subtitle">リアルタイム監視と運用判断のための統合ビュー</p>
        </div>
        <div class="page-header__meta" id="headerMeta">
          <span class="badge badge--info">稼働状態 <strong id="headerStatus">--</strong></span>
          <span class="badge badge--info">最終更新 <strong id="headerTimestamp">--</strong></span>
        </div>
      </div>
    </header>

    <main>
      <div class="layout-container">
        <section class="status-panel" aria-labelledby="section-status">
          <div class="status-panel__primary">
            <span class="status-indicator status-indicator--healthy" id="statusDot" aria-hidden="true"></span>
            <div class="status-panel__details">
              <div class="title" id="statusText">稼働状態: --</div>
              <div class="subtitle" id="uptimeText">アップタイム: --</div>
            </div>
          </div>
          <div class="status-panel__meta">
            <div class="label">バージョン</div>
            <div class="value" id="versionText">--</div>
            <div class="label">最終更新</div>
            <div class="value" id="timestampText">--</div>
          </div>
        </section>

        <div class="error-message" id="errorMessage" role="alert">
          サーバーに接続できません。稼働状態を確認してください。
        </div>

        <section class="grid grid--three" aria-labelledby="section-system">
          <article class="card" aria-labelledby="metric-cpu">
            <div class="card-header">
              <h2 class="card-title" id="metric-cpu">CPU使用率</h2>
              <span class="card-meta" id="cpuSubtitle">コア数: --</span>
            </div>
            <div class="card-value" id="cpuValue">--%</div>
            <div class="progress-bar" aria-hidden="true">
              <div class="progress-fill" id="cpuProgress" style="width: 0%"></div>
            </div>
          </article>

          <article class="card" aria-labelledby="metric-memory">
            <div class="card-header">
              <h2 class="card-title" id="metric-memory">メモリ使用率</h2>
              <span class="card-meta" id="memorySubtitle">総容量: --</span>
            </div>
            <div class="card-value" id="memoryValue">--%</div>
            <div class="progress-bar" aria-hidden="true">
              <div class="progress-fill" id="memoryProgress" style="width: 0%"></div>
            </div>
          </article>

          <article class="card" aria-labelledby="metric-event-loop">
            <div class="card-header">
              <h2 class="card-title" id="metric-event-loop">イベントループ遅延</h2>
              <span class="card-meta">低い値が望ましい</span>
            </div>
            <div class="card-value" id="eventLoopValue">-- ms</div>
            <div class="progress-bar" aria-hidden="true">
              <div class="progress-fill" id="eventLoopProgress" style="width: 0%"></div>
            </div>
          </article>
        </section>

        <section class="grid grid--two" aria-labelledby="section-metrics">
          <article class="card" aria-labelledby="metric-requests">
            <div class="card-header">
              <h2 class="card-title" id="metric-requests">リクエスト統計</h2>
            </div>
            <ul class="metrics-list">
              <li class="metrics-item">
                <span class="metrics-label">総リクエスト数</span>
                <span class="metrics-value" id="totalRequests">--</span>
              </li>
              <li class="metrics-item">
                <span class="metrics-label">エラー数</span>
                <span class="metrics-value" id="totalErrors">--</span>
              </li>
              <li class="metrics-item">
                <span class="metrics-label">レート制限</span>
                <span class="metrics-value" id="rateLimited">--</span>
              </li>
              <li class="metrics-item">
                <span class="metrics-label">アクティブ接続</span>
                <span class="metrics-value" id="activeConnections">--</span>
              </li>
              <li class="metrics-item">
                <span class="metrics-label">平均応答時間</span>
                <span class="metrics-value" id="avgResponseTime">-- ms</span>
              </li>
            </ul>
          </article>

          <article class="card" aria-labelledby="metric-performance">
            <div class="card-header">
              <h2 class="card-title" id="metric-performance">パフォーマンス指標</h2>
            </div>
            <ul class="metrics-list">
              <li class="metrics-item">
                <span class="metrics-label">キャッシュヒット率</span>
                <span class="metrics-value" id="cacheHitRate">--%</span>
              </li>
              <li class="metrics-item">
                <span class="metrics-label">P50応答時間</span>
                <span class="metrics-value" id="p50ResponseTime">-- ms</span>
              </li>
              <li class="metrics-item">
                <span class="metrics-label">P95応答時間</span>
                <span class="metrics-value" id="p95ResponseTime">-- ms</span>
              </li>
              <li class="metrics-item">
                <span class="metrics-label">P99応答時間</span>
                <span class="metrics-value" id="p99ResponseTime">-- ms</span>
              </li>
              <li class="metrics-item">
                <span class="metrics-label">キャッシュサイズ</span>
                <span class="metrics-value" id="cacheSize">--</span>
              </li>
            </ul>
          </article>

          <article class="card" aria-labelledby="metric-errors">
            <div class="card-header">
              <h2 class="card-title" id="metric-errors">エラー統計</h2>
            </div>
            <ul class="metrics-list">
              <li class="metrics-item">
                <span class="metrics-label">セキュリティ</span>
                <span class="metrics-value" id="errorSecurity">--</span>
              </li>
              <li class="metrics-item">
                <span class="metrics-label">検証エラー</span>
                <span class="metrics-value" id="errorValidation">--</span>
              </li>
              <li class="metrics-item">
                <span class="metrics-label">ファイルシステム</span>
                <span class="metrics-value" id="errorFileSystem">--</span>
              </li>
              <li class="metrics-item">
                <span class="metrics-label">サーバーエラー</span>
                <span class="metrics-value" id="errorServer">--</span>
              </li>
              <li class="metrics-item">
                <span class="metrics-label">エラー率</span>
                <span class="metrics-value" id="errorRate">-- /分</span>
              </li>
            </ul>
          </article>
        </section>

        <section class="alert-box" id="alertBox" role="status" aria-live="polite">
          <div class="alert-title">運用警告</div>
          <div class="alert-message" id="alertMessage"></div>
        </section>

        <p class="refresh-info">
          自動更新: 5秒ごと | データソース: /health, /api/stats
        </p>
      </div>
    </main>
  </div>

  <script>
    let updateInterval;

    async function fetchMetrics() {
      try {
        // Fetch health data
        const healthRes = await fetch('/health');
        const health = await healthRes.json();

        // Fetch stats data
        const statsRes = await fetch('/api/stats');
        const stats = await statsRes.json();

        // Hide error message
        document.getElementById('errorMessage').style.display = 'none';

        updateStatus(health);
        updateSystemMetrics(health?.metrics || {});
        updateServerStats(stats);
        updatePerformance(stats);
        updateErrors(stats);
        checkAlerts(health, stats);

      } catch (error) {
        console.error('Failed to fetch metrics:', error);
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('headerStatus').textContent = '不明';
        document.getElementById('headerStatus').closest('.badge').className = 'badge badge--warning';
      }
    }

    function updateStatus(health) {
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      const headerStatus = document.getElementById('headerStatus');
      const headerTimestamp = document.getElementById('headerTimestamp');

      const status = typeof health?.status === 'string' ? health.status : 'unknown';
      const statusClassMap = {
        healthy: 'status-indicator--healthy',
        degraded: 'status-indicator--warning',
        warning: 'status-indicator--warning',
        critical: 'status-indicator--critical',
        unknown: 'status-indicator--warning'
      };

      statusDot.className = `status-indicator ${statusClassMap[status] || 'status-indicator--warning'}`;
      statusText.textContent = status === 'healthy'
        ? '稼働状態: 正常'
        : status === 'warning' || status === 'degraded'
          ? '稼働状態: 要監視'
          : status === 'critical'
            ? '稼働状態: 重大'
            : '稼働状態: 不明';

      document.getElementById('uptimeText').textContent =
        `アップタイム: ${formatUptime(Number(health?.uptimeSeconds) || 0)}`;
      document.getElementById('versionText').textContent = health?.version || '不明';
      document.getElementById('timestampText').textContent =
        `最終更新: ${new Date().toLocaleTimeString('ja-JP')}`;

      headerStatus.textContent = statusText.textContent.replace('稼働状態: ', '');
      const statusBadge = headerStatus.closest('.badge');
      statusBadge.className = 'badge ' + (status === 'healthy'
        ? 'badge--success'
        : status === 'critical'
          ? 'badge--danger'
          : 'badge--warning');

      headerTimestamp.textContent = new Date().toLocaleTimeString('ja-JP');
    }

    function updateSystemMetrics(metrics) {
      if (!metrics || !metrics.system) {
        document.getElementById('cpuValue').textContent = '--%';
        document.getElementById('memoryValue').textContent = '--%';
        document.getElementById('eventLoopValue').textContent = '-- ms';
        return;
      }

      const cpuPercentRaw = Number(metrics.system?.cpu?.percent) || 0;
      const cpuPercent = (cpuPercentRaw * 100).toFixed(1);
      document.getElementById('cpuValue').textContent = cpuPercent + '%';
      updateProgressBar('cpuProgress', cpuPercent);
      document.getElementById('cpuSubtitle').textContent =
        `コア数: ${metrics.system?.cpu?.cores ?? '--'}`;

      const memoryPercentRaw = Number(metrics.system?.memory?.usagePercent) || 0;
      const memoryPercent = (memoryPercentRaw * 100).toFixed(1);
      document.getElementById('memoryValue').textContent = memoryPercent + '%';
      updateProgressBar('memoryProgress', memoryPercent);
      document.getElementById('memorySubtitle').textContent =
        `総容量: ${formatBytes(Number(metrics.system?.memory?.totalBytes) || 0)}`;

      const eventLoopLag = Number(metrics.system?.eventLoop?.lagMs) || 0;
      document.getElementById('eventLoopValue').textContent = `${eventLoopLag.toFixed(1)} ms`;
      const lagPercent = Math.min((eventLoopLag / 500) * 100, 100);
      updateProgressBar('eventLoopProgress', lagPercent);
    }

    function updateServerStats(stats) {
      if (!stats || !stats.server) {
        ['totalRequests', 'totalErrors', 'rateLimited', 'activeConnections', 'avgResponseTime'].forEach(id => {
          const el = document.getElementById(id);
          if (el) { el.textContent = '--'; }
        });
        return;
      }

      document.getElementById('totalRequests').textContent = Number(stats.server.requests || 0).toLocaleString();
      document.getElementById('totalErrors').textContent = stats.server.errors ?? 0;
      document.getElementById('rateLimited').textContent = stats.server.rateLimited ?? 0;
      document.getElementById('activeConnections').textContent = stats.server.activeConnections ?? 0;

      const uptimeMs = Number(stats.server.uptime || 0);
      const requestCount = Number(stats.server.requests || 0);
      const averageResponse = requestCount > 0 ? (uptimeMs / requestCount).toFixed(2) : '0.00';
      document.getElementById('avgResponseTime').textContent = `${averageResponse} ms`;
    }

    function updatePerformance(stats) {
      if (!stats || !stats.performance) {
        ['cacheHitRate', 'p50ResponseTime', 'p95ResponseTime', 'p99ResponseTime', 'cacheSize'].forEach(id => {
          const el = document.getElementById(id);
          if (el) { el.textContent = '--'; }
        });
        return;
      }

      const cache = stats.performance.cache || {};
      const responseTime = stats.performance.responseTime || {};

      document.getElementById('cacheHitRate').textContent =
        `${((Number(cache.hitRate) || 0) * 100).toFixed(1)}%`;
      document.getElementById('p50ResponseTime').textContent = `${responseTime.p50 ?? '--'} ms`;
      document.getElementById('p95ResponseTime').textContent = `${responseTime.p95 ?? '--'} ms`;
      document.getElementById('p99ResponseTime').textContent = `${responseTime.p99 ?? '--'} ms`;
      document.getElementById('cacheSize').textContent = cache.size ?? '--';
    }

    function updateErrors(stats) {
      if (!stats || !stats.errors) {
        ['errorSecurity', 'errorValidation', 'errorFileSystem', 'errorServer', 'errorRate'].forEach(id => {
          const el = document.getElementById(id);
          if (el) { el.textContent = '--'; }
        });
        return;
      }

      const counts = stats.errors.counts || {};
      document.getElementById('errorSecurity').textContent = counts.security ?? 0;
      document.getElementById('errorValidation').textContent = counts.validation ?? 0;
      document.getElementById('errorFileSystem').textContent = counts.fileSystem ?? 0;
      document.getElementById('errorServer').textContent = counts.serverError ?? 0;
      const perMinute = Number(stats.errors.rate?.errorsPerMinute) || 0;
      document.getElementById('errorRate').textContent = `${perMinute.toFixed(2)} /分`;
    }

    function updateProgressBar(id, percent) {
      const bar = document.getElementById(id);
      bar.style.width = percent + '%';

      bar.className = 'progress-fill';
      if (percent > 90) {
        bar.classList.add('is-critical');
      } else if (percent > 70) {
        bar.classList.add('is-warning');
      }
    }

    function checkAlerts(health, stats) {
      const alerts = [];
      const healthMetrics = health?.metrics?.system || {};
      const errorsRate = Number(stats?.errors?.rate?.errorsPerMinute) || 0;

      if ((Number(healthMetrics.memory?.usagePercent) || 0) > 0.9) {
        alerts.push('メモリ使用率が90%を超えています');
      }

      if ((Number(healthMetrics.cpu?.percent) || 0) > 0.9) {
        alerts.push('CPU使用率が90%を超えています');
      }

      if ((Number(healthMetrics.eventLoop?.lagMs) || 0) > 500) {
        alerts.push('イベントループの遅延が大きくなっています');
      }

      if (errorsRate > 10) {
        alerts.push('エラー率が高くなっています');
      }

      const alertBox = document.getElementById('alertBox');
      const alertMessage = document.getElementById('alertMessage');
      if (alerts.length > 0) {
        alertBox.classList.add('show');
        alertBox.setAttribute('aria-hidden', 'false');
        // XSS対策: innerHTMLの代わりにDOM APIを使用
        alertMessage.textContent = '';
        alerts.forEach(a => {
          const item = document.createElement('div');
          item.textContent = `• ${a}`;
          alertMessage.appendChild(item);
        });
      } else {
        alertBox.classList.remove('show');
        alertBox.setAttribute('aria-hidden', 'true');
      }
    }

    function formatUptime(seconds) {
      const days = Math.floor(seconds / 86400);
      const hours = Math.floor((seconds % 86400) / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);

      if (days > 0) return `${days}日 ${hours}時間`;
      if (hours > 0) return `${hours}時間 ${minutes}分`;
      return `${minutes}分`;
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Initial fetch
    fetchMetrics();

    // Auto-refresh every 5 seconds
    updateInterval = setInterval(fetchMetrics, 5000);
  </script>
</body>
</html>