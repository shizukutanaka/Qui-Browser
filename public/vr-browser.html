<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qui VR Browser - WebXR Optimized</title>
  <meta name="description" content="High-performance VR browser optimized for Meta Quest and Pico devices">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      overflow: hidden;
    }

    #container {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
    }

    #ui-overlay {
      position: relative;
      z-index: 10;
      text-align: center;
      max-width: 600px;
      padding: 2rem;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }

    h1 {
      font-size: 3rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }

    .subtitle {
      font-size: 1.2rem;
      opacity: 0.9;
      margin-bottom: 2rem;
    }

    #enter-vr-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: 3px solid white;
      color: white;
      font-size: 1.5rem;
      padding: 1rem 3rem;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    #enter-vr-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
    }

    #enter-vr-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #status {
      margin-top: 2rem;
      font-size: 1rem;
      opacity: 0.8;
    }

    .features {
      margin-top: 2rem;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      font-size: 0.9rem;
    }

    .feature {
      background: rgba(255, 255, 255, 0.1);
      padding: 0.75rem;
      border-radius: 10px;
    }

    .feature-icon {
      font-size: 1.5rem;
      margin-bottom: 0.25rem;
    }

    #performance-stats {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      display: none;
      z-index: 100;
    }

    .stat-line {
      margin: 2px 0;
    }

    #url-bar {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      max-width: 600px;
      background: rgba(0, 0, 0, 0.8);
      padding: 12px;
      border-radius: 30px;
      display: none;
      z-index: 100;
    }

    #url-input {
      width: 100%;
      background: transparent;
      border: none;
      color: white;
      font-size: 16px;
      outline: none;
    }

    #url-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div id="container">
    <canvas id="canvas"></canvas>

    <div id="ui-overlay">
      <h1>ü•Ω Qui VR Browser</h1>
      <p class="subtitle">WebXR-Optimized Browser for VR Devices</p>

      <button id="enter-vr-btn">Enter VR</button>

      <div id="status">Checking VR support...</div>

      <div class="features">
        <div class="feature">
          <div class="feature-icon">‚ö°</div>
          <div>90/120Hz Rendering</div>
        </div>
        <div class="feature">
          <div class="feature-icon">üëÅÔ∏è</div>
          <div>Foveated Rendering</div>
        </div>
        <div class="feature">
          <div class="feature-icon">üëã</div>
          <div>Hand Tracking</div>
        </div>
        <div class="feature">
          <div class="feature-icon">üéØ</div>
          <div>Eye Tracking</div>
        </div>
      </div>
    </div>

    <div id="performance-stats">
      <div class="stat-line">FPS: <span id="fps">0</span></div>
      <div class="stat-line">Frame Time: <span id="frame-time">0</span>ms</div>
      <div class="stat-line">GPU: <span id="gpu">Unknown</span></div>
      <div class="stat-line">Foveation: <span id="foveation">Off</span></div>
      <div class="stat-line">Input: <span id="input-mode">None</span></div>
    </div>

    <div id="url-bar">
      <input type="text" id="url-input" placeholder="Enter URL or search..." />
    </div>
  </div>

  <script type="module">
    // VR Browser Client-Side Implementation

    class QuiVRBrowserClient {
      constructor() {
        this.xrSession = null;
        this.xrRefSpace = null;
        this.gl = null;
        this.canvas = null;
        this.isVRActive = false;

        // Performance tracking
        this.frameCount = 0;
        this.lastTime = 0;
        this.fps = 0;

        // UI elements
        this.enterVRBtn = document.getElementById('enter-vr-btn');
        this.statusText = document.getElementById('status');
        this.performanceStats = document.getElementById('performance-stats');
        this.uiOverlay = document.getElementById('ui-overlay');
        this.urlBar = document.getElementById('url-bar');
        this.canvas = document.getElementById('canvas');

        this.init();
      }

      async init() {
        // Check WebXR support
        if (!navigator.xr) {
          this.updateStatus('‚ùå WebXR not supported in this browser');
          this.enterVRBtn.disabled = true;
          return;
        }

        // Check VR support
        const vrSupported = await navigator.xr.isSessionSupported('immersive-vr');
        if (!vrSupported) {
          this.updateStatus('‚ùå VR mode not supported on this device');
          this.enterVRBtn.disabled = true;
          return;
        }

        this.updateStatus('‚úÖ VR Ready - Click to enter VR');
        this.enterVRBtn.disabled = false;

        // Setup event listeners
        this.enterVRBtn.addEventListener('click', () => this.enterVR());
      }

      async enterVR() {
        try {
          this.updateStatus('üîÑ Entering VR mode...');

          // Request VR session
          const sessionInit = {
            requiredFeatures: ['local'],
            optionalFeatures: [
              'hand-tracking',
              'layers'
            ]
          };

          this.xrSession = await navigator.xr.requestSession('immersive-vr', sessionInit);

          // Setup WebGL
          await this.setupWebGL();

          // Setup XR layers
          const glLayer = new XRWebGLLayer(this.xrSession, this.gl);
          await this.xrSession.updateRenderState({ baseLayer: glLayer });

          // Setup reference space
          this.xrRefSpace = await this.xrSession.requestReferenceSpace('local');

          // Enable foveated rendering if supported
          this.setupFoveatedRendering(glLayer);

          // Setup session handlers
          this.xrSession.addEventListener('end', () => this.exitVR());

          // Hide UI overlay, show VR UI
          this.uiOverlay.classList.add('hidden');
          this.performanceStats.style.display = 'block';
          this.canvas.style.display = 'block';

          // Start render loop
          this.isVRActive = true;
          this.xrSession.requestAnimationFrame((time, frame) => this.onXRFrame(time, frame));

          console.log('[Qui VR] VR mode activated');
        } catch (error) {
          console.error('[Qui VR] Failed to enter VR:', error);
          this.updateStatus('‚ùå Failed to enter VR: ' + error.message);
        }
      }

      async setupWebGL() {
        const gl = this.canvas.getContext('webgl2', {
          xrCompatible: true,
          alpha: false,
          antialias: false,
          depth: true,
          stencil: false,
          powerPreference: 'high-performance'
        });

        if (!gl) {
          throw new Error('WebGL2 not supported');
        }

        this.gl = gl;

        // Setup rendering state
        gl.enable(gl.DEPTH_TEST);
        gl.enable(gl.CULL_FACE);
        gl.clearColor(0.0, 0.0, 0.0, 1.0);

        // Get GPU info
        const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
        if (debugInfo) {
          const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
          document.getElementById('gpu').textContent = renderer;
        }
      }

      setupFoveatedRendering(glLayer) {
        if (typeof glLayer.fixedFoveation !== 'undefined') {
          // Enable medium foveation level (0.0 - 1.0)
          glLayer.fixedFoveation = 0.5;
          document.getElementById('foveation').textContent = 'Medium';
          console.log('[Qui VR] Foveated rendering enabled');
        }
      }

      onXRFrame(time, frame) {
        const session = frame.session;

        // Schedule next frame
        session.requestAnimationFrame((time, frame) => this.onXRFrame(time, frame));

        // Update performance stats
        this.updatePerformanceStats(time);

        // Get pose
        const pose = frame.getViewerPose(this.xrRefSpace);
        if (!pose) return;

        // Get WebGL layer
        const glLayer = session.renderState.baseLayer;
        this.gl.bindFramebuffer(this.gl.FRAMEBUFFER, glLayer.framebuffer);

        // Clear
        this.gl.clear(this.gl.COLOR_BUFFER_BIT | this.gl.DEPTH_BUFFER_BIT);

        // Render each eye
        for (const view of pose.views) {
          const viewport = glLayer.getViewport(view);
          this.gl.viewport(viewport.x, viewport.y, viewport.width, viewport.height);

          // Render scene
          this.renderScene(view, pose);
        }

        // Handle input
        this.handleInput(frame);
      }

      renderScene(view, pose) {
        // Simple gradient background for demo
        const gl = this.gl;

        // In production, this would render the actual browser content
        // For now, just clear to a nice gradient color
        const color = 0.5 + Math.sin(Date.now() * 0.001) * 0.5;
        gl.clearColor(color * 0.2, color * 0.3, color * 0.5, 1.0);
      }

      handleInput(frame) {
        // Detect input mode
        let inputMode = 'None';

        for (const inputSource of frame.session.inputSources) {
          if (inputSource.hand) {
            inputMode = 'Hands';
          } else if (inputSource.targetRayMode === 'tracked-pointer') {
            inputMode = 'Controllers';
          } else if (inputSource.targetRayMode === 'gaze') {
            inputMode = 'Gaze';
          }
        }

        document.getElementById('input-mode').textContent = inputMode;
      }

      updatePerformanceStats(time) {
        this.frameCount++;

        if (this.lastTime === 0) {
          this.lastTime = time;
          return;
        }

        const deltaTime = time - this.lastTime;

        // Update every 30 frames
        if (this.frameCount % 30 === 0) {
          this.fps = 1000 / deltaTime;
          document.getElementById('fps').textContent = this.fps.toFixed(1);
          document.getElementById('frame-time').textContent = deltaTime.toFixed(2);
        }

        this.lastTime = time;
      }

      exitVR() {
        console.log('[Qui VR] Exiting VR mode');

        if (this.xrSession) {
          this.xrSession.end();
          this.xrSession = null;
        }

        this.isVRActive = false;

        // Show UI overlay, hide VR UI
        this.uiOverlay.classList.remove('hidden');
        this.performanceStats.style.display = 'none';
        this.canvas.style.display = 'none';

        this.updateStatus('‚úÖ VR Ready - Click to enter VR');
      }

      updateStatus(message) {
        this.statusText.textContent = message;
      }
    }

    // Initialize VR browser client
    const vrBrowser = new QuiVRBrowserClient();

    // Make it globally accessible for debugging
    window.vrBrowser = vrBrowser;
  </script>
</body>
</html>
