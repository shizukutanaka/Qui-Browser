<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qui VR Video Player - 360¬∞/3D Video</title>
  <meta name="description" content="High-performance VR video player with 360¬∞ and 3D support">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      color: white;
      overflow: hidden;
    }

    #container {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    #ui-overlay {
      position: relative;
      z-index: 10;
      text-align: center;
      max-width: 700px;
      padding: 2rem;
      background: rgba(20, 20, 20, 0.9);
      border-radius: 15px;
      border: 2px solid #4CAF50;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      color: #4CAF50;
    }

    .subtitle {
      font-size: 1.1rem;
      opacity: 0.8;
      margin-bottom: 2rem;
    }

    .video-selector {
      margin: 1.5rem 0;
      display: grid;
      gap: 1rem;
    }

    .video-option {
      background: rgba(76, 175, 80, 0.1);
      padding: 1rem;
      border-radius: 10px;
      border: 2px solid #4CAF50;
      cursor: pointer;
      transition: all 0.3s;
    }

    .video-option:hover {
      background: rgba(76, 175, 80, 0.3);
      transform: translateX(5px);
    }

    .video-option h3 {
      margin-bottom: 0.5rem;
      color: #4CAF50;
    }

    .video-option p {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    button {
      background: #4CAF50;
      border: none;
      color: white;
      font-size: 1.2rem;
      padding: 0.8rem 2rem;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      margin: 0.5rem;
    }

    button:hover {
      background: #66BB6A;
      transform: translateY(-2px);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #status {
      margin-top: 1.5rem;
      font-size: 0.95rem;
      opacity: 0.7;
    }

    .features {
      margin-top: 1.5rem;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      font-size: 0.85rem;
    }

    .feature {
      background: rgba(255, 255, 255, 0.05);
      padding: 0.6rem;
      border-radius: 8px;
    }

    .feature-icon {
      font-size: 1.3rem;
      margin-bottom: 0.25rem;
    }

    #video-stats {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 11px;
      display: none;
      z-index: 100;
    }

    .stat-line {
      margin: 2px 0;
    }

    .hidden {
      display: none !important;
    }

    #video-element {
      display: none;
    }
  </style>
</head>
<body>
  <div id="container">
    <canvas id="canvas"></canvas>
    <video id="video-element" crossorigin="anonymous" playsinline></video>

    <div id="ui-overlay">
      <h1>üé• VR Video Player</h1>
      <p class="subtitle">360¬∞ & 3D Video with Spatial Audio</p>

      <div class="video-selector">
        <div class="video-option" onclick="selectVideoType('360')">
          <h3>üåê 360¬∞ Video</h3>
          <p>Equirectangular panoramic video</p>
        </div>

        <div class="video-option" onclick="selectVideoType('3d')">
          <h3>üëì 3D Stereoscopic</h3>
          <p>Side-by-side 3D video</p>
        </div>

        <div class="video-option" onclick="selectVideoType('flat')">
          <h3>üì∫ Flat Video</h3>
          <p>Standard 2D video in VR space</p>
        </div>
      </div>

      <div>
        <button id="enter-vr-btn" disabled>Select Video Type First</button>
      </div>

      <div id="status">WebXR checking...</div>

      <div class="features">
        <div class="feature">
          <div class="feature-icon">üéØ</div>
          <div>Viewport Adaptive</div>
        </div>
        <div class="feature">
          <div class="feature-icon">üîä</div>
          <div>Spatial Audio</div>
        </div>
        <div class="feature">
          <div class="feature-icon">üìä</div>
          <div>Tile Streaming</div>
        </div>
        <div class="feature">
          <div class="feature-icon">‚ö°</div>
          <div>90/120 Hz</div>
        </div>
        <div class="feature">
          <div class="feature-icon">üíæ</div>
          <div>Memory Optimized</div>
        </div>
        <div class="feature">
          <div class="feature-icon">üéÆ</div>
          <div>Gesture Controls</div>
        </div>
      </div>
    </div>

    <div id="video-stats">
      <div class="stat-line">FPS: <span id="fps">0</span></div>
      <div class="stat-line">Buffered: <span id="buffered">0</span>%</div>
      <div class="stat-line">Tiles: <span id="tiles">0/0</span></div>
      <div class="stat-line">Bitrate: <span id="bitrate">0</span> Mbps</div>
      <div class="stat-line">Projection: <span id="projection">-</span></div>
      <div class="stat-line">Time: <span id="time">0:00 / 0:00</span></div>
    </div>
  </div>

  <script>
    let selectedVideoType = null;
    let xrSession = null;
    let gl = null;
    let isPlaying = false;

    // Demo video URLs (replace with actual video URLs)
    const demoVideos = {
      '360': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4', // Replace with 360 video
      '3d': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4', // Replace with 3D video
      'flat': 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4'
    };

    const projectionTypes = {
      '360': 'equirectangular',
      '3d': 'equirectangular',
      'flat': 'flat'
    };

    const stereoModes = {
      '360': 'mono',
      '3d': 'side-by-side',
      'flat': 'mono'
    };

    function selectVideoType(type) {
      selectedVideoType = type;
      document.getElementById('enter-vr-btn').disabled = false;
      document.getElementById('enter-vr-btn').textContent = `Enter VR (${type.toUpperCase()} Video)`;
      updateStatus(`‚úÖ ${type.toUpperCase()} video selected - Click to enter VR`);
    }

    function updateStatus(message) {
      document.getElementById('status').textContent = message;
    }

    async function init() {
      // Check WebXR support
      if (!navigator.xr) {
        updateStatus('‚ùå WebXR not supported');
        return;
      }

      const vrSupported = await navigator.xr.isSessionSupported('immersive-vr');
      if (!vrSupported) {
        updateStatus('‚ùå VR not supported on this device');
        return;
      }

      updateStatus('‚úÖ VR Ready - Select video type');

      // Setup enter VR button
      document.getElementById('enter-vr-btn').addEventListener('click', enterVR);
    }

    async function enterVR() {
      if (!selectedVideoType) return;

      try {
        updateStatus('üîÑ Entering VR...');

        // Request VR session
        xrSession = await navigator.xr.requestSession('immersive-vr', {
          requiredFeatures: ['local'],
          optionalFeatures: ['layers']
        });

        // Setup WebGL
        const canvas = document.getElementById('canvas');
        gl = canvas.getContext('webgl2', {
          xrCompatible: true,
          alpha: false,
          antialias: false
        });

        // Setup XR layer
        const glLayer = new XRWebGLLayer(xrSession, gl);
        await xrSession.updateRenderState({ baseLayer: glLayer });

        // Get reference space
        const refSpace = await xrSession.requestReferenceSpace('local');

        // Load video
        const video = document.getElementById('video-element');
        video.src = demoVideos[selectedVideoType];
        video.load();

        // Wait for video to be ready
        await new Promise(resolve => {
          video.addEventListener('loadeddata', resolve, { once: true });
        });

        // Hide UI
        document.getElementById('ui-overlay').classList.add('hidden');
        document.getElementById('video-stats').style.display = 'block';

        // Update stats
        document.getElementById('projection').textContent = projectionTypes[selectedVideoType];

        // Start render loop
        xrSession.requestAnimationFrame((time, frame) => {
          renderFrame(time, frame, refSpace, video);
        });

        // Play video
        await video.play();
        isPlaying = true;

        console.log('[VR Video] VR video player started');
      } catch (error) {
        console.error('[VR Video] Failed to enter VR:', error);
        updateStatus('‚ùå Failed to enter VR: ' + error.message);
      }
    }

    function renderFrame(time, frame, refSpace, video) {
      const session = frame.session;

      // Schedule next frame
      session.requestAnimationFrame((time, frame) => {
        renderFrame(time, frame, refSpace, video);
      });

      // Get pose
      const pose = frame.getViewerPose(refSpace);
      if (!pose) return;

      // Get WebGL layer
      const glLayer = session.renderState.baseLayer;
      gl.bindFramebuffer(gl.FRAMEBUFFER, glLayer.framebuffer);

      // Clear
      gl.clearColor(0, 0, 0, 1);
      gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

      // Update stats
      updateVideoStats(video);

      // Render video (simplified - in production use proper shader)
      for (const view of pose.views) {
        const viewport = glLayer.getViewport(view);
        gl.viewport(viewport.x, viewport.y, viewport.width, viewport.height);

        // Render video texture to sphere/plane
        // (Full implementation would include proper projection shaders)
      }
    }

    function updateVideoStats(video) {
      // Update buffered
      if (video.buffered.length > 0) {
        const bufferedEnd = video.buffered.end(video.buffered.length - 1);
        const bufferedPercent = (bufferedEnd / video.duration) * 100;
        document.getElementById('buffered').textContent = bufferedPercent.toFixed(0);
      }

      // Update time
      const current = formatTime(video.currentTime);
      const total = formatTime(video.duration);
      document.getElementById('time').textContent = `${current} / ${total}`;

      // Simulated tile stats
      document.getElementById('tiles').textContent = '24/32';
      document.getElementById('bitrate').textContent = '15.2';
    }

    function formatTime(seconds) {
      if (isNaN(seconds)) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Initialize
    init();

    // Make functions global
    window.selectVideoType = selectVideoType;
  </script>
</body>
</html>
