<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Features - Qui Browser VR Example</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #ffffff;
            overflow: hidden;
        }

        #container {
            width: 100vw;
            height: 100vh;
        }

        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 10px;
            max-width: 300px;
            max-height: 80vh;
            overflow-y: auto;
        }

        h2 {
            margin: 0 0 15px 0;
            font-size: 20px;
            color: #00ffff;
            border-bottom: 2px solid #00ffff;
            padding-bottom: 5px;
        }

        .control-group {
            margin: 15px 0;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #aaaaaa;
        }

        .control-group select,
        .control-group button {
            width: 100%;
            padding: 10px;
            background: rgba(0, 255, 255, 0.2);
            border: 1px solid #00ffff;
            border-radius: 5px;
            color: #ffffff;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-group select:hover,
        .control-group button:hover {
            background: rgba(0, 255, 255, 0.4);
        }

        .control-group button {
            background: linear-gradient(135deg, #00ffff 0%, #0099ff 100%);
            color: #000;
            font-weight: bold;
            margin-top: 5px;
        }

        #info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-width: 400px;
        }

        .info-item {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }

        .info-label {
            color: #00ffff;
        }

        .info-value {
            color: #ffffff;
            font-weight: bold;
        }

        #vr-button {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 15px 30px;
            background: linear-gradient(135deg, #ff00ff 0%, #ff0099 100%);
            color: #fff;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(255, 0, 255, 0.3);
        }

        #vr-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(255, 0, 255, 0.5);
        }
    </style>
</head>
<body>
    <div id="container"></div>

    <button id="vr-button">VRモード起動</button>

    <div id="controls">
        <h2>高度な機能</h2>

        <div class="control-group">
            <label>環境プリセット</label>
            <select id="environment-select">
                <option value="space">Space（宇宙）</option>
                <option value="forest">Forest（森）</option>
                <option value="ocean">Ocean（海）</option>
                <option value="minimal">Minimal（ミニマル）</option>
                <option value="sunset">Sunset（夕焼け）</option>
                <option value="cyberpunk">Cyberpunk（サイバーパンク）</option>
            </select>
        </div>

        <div class="control-group">
            <label>UIレイアウト</label>
            <select id="ui-layout-select">
                <option value="default">Default（デフォルト）</option>
                <option value="comfortable">Comfortable（快適）</option>
                <option value="theater">Theater（シアター）</option>
                <option value="floating">Floating（フローティング）</option>
            </select>
        </div>

        <div class="control-group">
            <label>タブレイアウト</label>
            <select id="tab-layout-select">
                <option value="arc">Arc（弧）</option>
                <option value="stack">Stack（スタック）</option>
                <option value="grid">Grid（グリッド）</option>
                <option value="cylinder">Cylinder（円筒）</option>
            </select>
        </div>

        <div class="control-group">
            <label>ブックマークレイアウト</label>
            <select id="bookmark-layout-select">
                <option value="grid">Grid（グリッド）</option>
                <option value="sphere">Sphere（球体）</option>
                <option value="wall">Wall（壁）</option>
                <option value="carousel">Carousel（カルーセル）</option>
            </select>
        </div>

        <div class="control-group">
            <label>アクション</label>
            <button id="show-bookmarks-btn">ブックマーク表示</button>
            <button id="show-tabs-btn">タブマネージャー表示</button>
            <button id="start-profiler-btn">プロファイラー起動</button>
            <button id="play-spatial-audio-btn">空間オーディオテスト</button>
        </div>

        <div class="control-group">
            <label>ジェスチャーマクロ</label>
            <button id="record-macro-btn">マクロ録画開始</button>
            <button id="stop-macro-btn" disabled>マクロ録画停止</button>
            <button id="play-macro-btn">マクロ再生</button>
        </div>
    </div>

    <div id="info-panel">
        <div class="info-item">
            <span class="info-label">FPS:</span>
            <span class="info-value" id="fps-value">--</span>
        </div>
        <div class="info-item">
            <span class="info-label">Frame Time:</span>
            <span class="info-value" id="frametime-value">--</span>
        </div>
        <div class="info-item">
            <span class="info-label">Memory:</span>
            <span class="info-value" id="memory-value">--</span>
        </div>
        <div class="info-item">
            <span class="info-label">Environment:</span>
            <span class="info-value" id="env-value">space</span>
        </div>
        <div class="info-item">
            <span class="info-label">UI Layout:</span>
            <span class="info-value" id="layout-value">default</span>
        </div>
    </div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>

    <!-- VR Modules - Core -->
    <script src="../assets/js/vr-utils.js"></script>
    <script src="../assets/js/vr-launcher.js"></script>

    <!-- VR Modules - UI/UX -->
    <script src="../assets/js/vr-text-renderer.js"></script>
    <script src="../assets/js/vr-ergonomic-ui.js"></script>
    <script src="../assets/js/vr-comfort-system.js"></script>
    <script src="../assets/js/vr-input-optimizer.js"></script>
    <script src="../assets/js/vr-accessibility-enhanced.js"></script>

    <!-- VR Modules - Advanced -->
    <script src="../assets/js/vr-environment-customizer.js"></script>
    <script src="../assets/js/vr-gesture-macro.js"></script>
    <script src="../assets/js/vr-content-optimizer.js"></script>
    <script src="../assets/js/vr-performance-profiler.js"></script>

    <!-- VR Modules - 3D -->
    <script src="../assets/js/vr-bookmark-3d.js"></script>
    <script src="../assets/js/vr-tab-manager-3d.js"></script>
    <script src="../assets/js/vr-spatial-audio.js"></script>

    <script>
        // グローバル変数
        let scene, camera, renderer, clock;
        let vrLauncher, ergoUI, comfortSystem, inputOptimizer;
        let envCustomizer, gestureMacro, contentOptimizer, profiler;
        let bookmark3D, tabManager3D, spatialAudio;
        let isVRActive = false;
        let isRecording = false;

        // 初期化
        function init() {
            console.log('Initializing Advanced Features Demo...');

            // Three.jsシーン
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(90, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.6, 0);

            // レンダラー
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.xr.enabled = true;
            document.getElementById('container').appendChild(renderer.domElement);

            clock = new THREE.Clock();

            // VRシステム初期化
            initVRSystems();

            // サンプルコンテンツ
            addAdvancedContent();

            // イベントリスナー
            setupEventListeners();

            // アニメーションループ
            renderer.setAnimationLoop(animate);

            // パフォーマンスモニター更新
            setInterval(updatePerformanceInfo, 1000);

            console.log('Advanced Features Demo initialized!');
        }

        // VRシステム初期化
        function initVRSystems() {
            // コアシステム
            vrLauncher = new VRLauncher();
            ergoUI = new VRErgonomicUI();
            ergoUI.init(camera, scene);
            comfortSystem = new VRComfortSystem();
            comfortSystem.init(scene, camera);
            inputOptimizer = new VRInputOptimizer();
            inputOptimizer.init(camera, scene, renderer);

            // 高度な機能
            envCustomizer = new VREnvironmentCustomizer();
            envCustomizer.init(scene, camera);

            gestureMacro = new VRGestureMacro();
            // ハンドトラッキングシステムがあれば初期化
            // gestureMacro.init(handTrackingSystem);

            contentOptimizer = new VRContentOptimizer();
            contentOptimizer.init(renderer);

            profiler = new VRPerformanceProfiler();
            profiler.init(renderer, scene);

            // 3D視覚化
            bookmark3D = new VRBookmark3D();
            bookmark3D.init(scene, camera);

            tabManager3D = new VRTabManager3D();
            tabManager3D.init(scene, camera);

            spatialAudio = new VRSpatialAudio();
            spatialAudio.init(camera);

            // デフォルト環境設定
            envCustomizer.setEnvironmentPreset('space');

            // サンプルブックマーク追加
            addSampleBookmarks();

            // サンプルタブ追加
            addSampleTabs();

            console.log('All VR systems initialized');
        }

        // サンプルブックマーク追加
        function addSampleBookmarks() {
            const sampleBookmarks = [
                { title: 'Google', url: 'https://google.com', category: 'search' },
                { title: 'GitHub', url: 'https://github.com', category: 'dev' },
                { title: 'YouTube', url: 'https://youtube.com', category: 'media' },
                { title: 'Twitter', url: 'https://twitter.com', category: 'social' },
                { title: 'Wikipedia', url: 'https://wikipedia.org', category: 'reference' },
                { title: 'Stack Overflow', url: 'https://stackoverflow.com', category: 'dev' }
            ];

            sampleBookmarks.forEach(bookmark => {
                bookmark3D.addBookmark(bookmark);
            });
        }

        // サンプルタブ追加
        function addSampleTabs() {
            const sampleTabs = [
                { url: 'https://example.com', title: 'Example', active: true },
                { url: 'https://github.com', title: 'GitHub', active: false },
                { url: 'https://google.com', title: 'Google', active: false }
            ];

            sampleTabs.forEach(tab => {
                tabManager3D.createTab(tab);
            });
        }

        // 高度なコンテンツ追加
        function addAdvancedContent() {
            // 床
            const gridHelper = new THREE.GridHelper(30, 30, 0x00ffff, 0x333333);
            scene.add(gridHelper);

            // ライティング
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const pointLight1 = new THREE.PointLight(0x00ffff, 1, 50);
            pointLight1.position.set(5, 5, 5);
            scene.add(pointLight1);

            const pointLight2 = new THREE.PointLight(0xff00ff, 1, 50);
            pointLight2.position.set(-5, 5, -5);
            scene.add(pointLight2);

            // サンプルオブジェクト（空間オーディオ付き）
            const sphereGeometry = new THREE.SphereGeometry(0.2, 32, 32);
            const sphereMaterial = new THREE.MeshStandardMaterial({
                color: 0x00ffff,
                metalness: 0.7,
                roughness: 0.3,
                emissive: 0x00ffff,
                emissiveIntensity: 0.2
            });

            for (let i = 0; i < 5; i++) {
                const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial.clone());
                const angle = (i / 5) * Math.PI * 2;
                const radius = 3;
                sphere.position.set(
                    Math.cos(angle) * radius,
                    1.6,
                    Math.sin(angle) * radius
                );
                scene.add(sphere);

                // インタラクティブオブジェクトとして登録
                inputOptimizer.registerInteractiveObject(sphere, {
                    onHover: () => {
                        sphere.material.emissiveIntensity = 0.5;
                    },
                    onSelect: () => {
                        sphere.material.color.setHex(Math.random() * 0xffffff);
                        spatialAudio.playSound('click', sphere.position, { volume: 0.5 });
                    }
                });
            }

            console.log('Advanced content added');
        }

        // イベントリスナー設定
        function setupEventListeners() {
            // VRボタン
            document.getElementById('vr-button').addEventListener('click', toggleVR);

            // 環境選択
            document.getElementById('environment-select').addEventListener('change', (e) => {
                const preset = e.target.value;
                envCustomizer.setEnvironmentPreset(preset);
                document.getElementById('env-value').textContent = preset;
                spatialAudio.playSound('navigate', camera.position);
            });

            // UIレイアウト選択
            document.getElementById('ui-layout-select').addEventListener('change', (e) => {
                const layout = e.target.value;
                envCustomizer.setUILayoutPreset(layout);
                document.getElementById('layout-value').textContent = layout;
                spatialAudio.playSound('navigate', camera.position);
            });

            // タブレイアウト選択
            document.getElementById('tab-layout-select').addEventListener('change', (e) => {
                tabManager3D.setLayout(e.target.value);
                spatialAudio.playSound('tab-switch', camera.position);
            });

            // ブックマークレイアウト選択
            document.getElementById('bookmark-layout-select').addEventListener('change', (e) => {
                bookmark3D.setLayout(e.target.value);
                spatialAudio.playSound('navigate', camera.position);
            });

            // ブックマーク表示
            document.getElementById('show-bookmarks-btn').addEventListener('click', () => {
                bookmark3D.show();
                spatialAudio.playSound('menu-open', camera.position);
            });

            // タブマネージャー表示
            document.getElementById('show-tabs-btn').addEventListener('click', () => {
                // タブマネージャーは常に表示されているため、カメラを移動
                spatialAudio.playSound('menu-open', camera.position);
                window.vrUtils.showNotification('Info', 'Tab Manager is always visible', 'info', 2000);
            });

            // プロファイラー起動
            document.getElementById('start-profiler-btn').addEventListener('click', () => {
                profiler.startProfiling();
                spatialAudio.playSound('notification', camera.position);
                window.vrUtils.showNotification('Success', 'Profiler started', 'success', 2000);

                setTimeout(() => {
                    const results = profiler.stopProfiling();
                    console.log('Profiling results:', results);
                    const recommendations = profiler.getRecommendations();
                    console.log('Recommendations:', recommendations);
                    window.vrUtils.showNotification(
                        'Profiler Complete',
                        `FPS: ${results.fps.average.toFixed(1)}`,
                        'info',
                        3000
                    );
                }, 5000);
            });

            // 空間オーディオテスト
            document.getElementById('play-spatial-audio-btn').addEventListener('click', () => {
                const testPosition = new THREE.Vector3(2, 1.6, -2);
                spatialAudio.playSound('notification', testPosition, { volume: 0.8 });
                setTimeout(() => spatialAudio.playSound('success', new THREE.Vector3(-2, 1.6, -2)), 500);
                setTimeout(() => spatialAudio.playSound('click', new THREE.Vector3(0, 1.6, -3)), 1000);
            });

            // マクロ録画
            document.getElementById('record-macro-btn').addEventListener('click', () => {
                gestureMacro.startRecording('demo-macro');
                isRecording = true;
                document.getElementById('record-macro-btn').disabled = true;
                document.getElementById('stop-macro-btn').disabled = false;
                window.vrUtils.showNotification('Info', 'Recording macro...', 'info', 2000);
            });

            document.getElementById('stop-macro-btn').addEventListener('click', () => {
                const macro = gestureMacro.stopRecording();
                isRecording = false;
                document.getElementById('record-macro-btn').disabled = false;
                document.getElementById('stop-macro-btn').disabled = true;
                console.log('Macro recorded:', macro);
                window.vrUtils.showNotification('Success', 'Macro saved!', 'success', 2000);
            });

            document.getElementById('play-macro-btn').addEventListener('click', () => {
                gestureMacro.playMacro('demo-macro')
                    .then(() => {
                        window.vrUtils.showNotification('Success', 'Macro completed!', 'success', 2000);
                    })
                    .catch(err => {
                        console.error('Macro playback error:', err);
                        window.vrUtils.showNotification('Error', 'No macro to play', 'error', 2000);
                    });
            });

            // VRセッションイベント
            window.addEventListener('vr-session-started', () => {
                isVRActive = true;
                document.getElementById('vr-button').textContent = 'VRモード終了';
            });

            window.addEventListener('vr-session-ended', () => {
                isVRActive = false;
                document.getElementById('vr-button').textContent = 'VRモード起動';
            });

            // ウィンドウリサイズ
            window.addEventListener('resize', onWindowResize);
        }

        // VRモード切り替え
        async function toggleVR() {
            if (isVRActive) {
                await vrLauncher.exitVR();
            } else {
                try {
                    const supported = await vrLauncher.checkVRSupport();
                    if (supported) {
                        await vrLauncher.enterVR();
                    } else {
                        alert('このデバイスはWebXRをサポートしていません。');
                    }
                } catch (err) {
                    console.error('VR起動エラー:', err);
                    alert('VRモードの起動に失敗しました: ' + err.message);
                }
            }
        }

        // パフォーマンス情報更新
        function updatePerformanceInfo() {
            const metrics = profiler.getMetrics();

            document.getElementById('fps-value').textContent =
                metrics.fps.current ? `${metrics.fps.current.toFixed(1)} fps` : '--';

            document.getElementById('frametime-value').textContent =
                metrics.frameTime.current ? `${metrics.frameTime.current.toFixed(1)} ms` : '--';

            if (metrics.memory && metrics.memory.used) {
                document.getElementById('memory-value').textContent =
                    `${(metrics.memory.used / 1024 / 1024).toFixed(0)} MB`;
            }
        }

        // ウィンドウリサイズ
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // アニメーションループ
        function animate() {
            const deltaTime = clock.getDelta();

            // システム更新
            ergoUI.update(deltaTime);
            comfortSystem.update(deltaTime);
            inputOptimizer.update(deltaTime);
            envCustomizer.update(deltaTime);
            profiler.update(deltaTime);

            renderer.render(scene, camera);
        }

        // ページロード時に初期化
        window.addEventListener('load', init);
    </script>
</body>
</html>
