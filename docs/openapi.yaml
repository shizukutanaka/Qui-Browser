openapi: 3.1.0
info:
  title: Qui Browser API
  description: |
    Enterprise-grade lightweight web server with national-level security and reliability.

    ## Features
    - OWASP Top 10 compliant security
    - DDoS protection and rate limiting
    - Tamper-proof audit logging
    - Multi-tier caching
    - WebXR/VR optimization
    - AI Copilot integration
    - Privacy protection

    ## Authentication
    - Admin endpoints: Bearer token authentication
    - Session endpoints: Encrypted session cookies
    - Public endpoints: No authentication required

  version: 1.1.0
  contact:
    name: Qui Browser Team
    email: support@qui-browser.com
    url: https://qui-browser.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8000
    description: Development server
  - url: https://api.qui-browser.com
    description: Production server

tags:
  - name: Health & Monitoring
    description: System health checks and metrics
  - name: Cache Management
    description: Cache control and statistics
  - name: Session Management
    description: User session operations
  - name: Security
    description: Security and audit operations
  - name: Performance
    description: Performance profiling
  - name: Billing
    description: Stripe billing integration
  - name: AI Copilot
    description: AI-powered assistance
  - name: Privacy
    description: Privacy protection features
  - name: VR/WebXR
    description: Virtual reality functionality

security:
  - bearerAuth: []
  - sessionCookie: []

paths:
  /health:
    get:
      tags:
        - Health & Monitoring
      summary: Health check
      description: Check system health status
      operationId: getHealth
      security: []
      responses:
        '200':
          description: System is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                healthy:
                  value:
                    status: healthy
                    timestamp: '2025-10-12T10:00:00.000Z'
                    uptime: 86400
                    version: 1.1.0
                    system:
                      memory:
                        used: 134217728
                        total: 1073741824
                        percentage: 12.5
                      cpu:
                        usage: 15.5
                        cores: 4
                      eventLoop:
                        lag: 2.3
                    dependencies:
                      filesystem: true
                      cache: true
                      database: true

  /metrics:
    get:
      tags:
        - Health & Monitoring
      summary: Get metrics
      description: Get performance metrics
      operationId: getMetrics
      security: []
      responses:
        '200':
          description: Metrics retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsResponse'

  /performance:
    get:
      tags:
        - Health & Monitoring
      summary: Get performance data
      description: Get detailed performance profiling data (requires ENABLE_PROFILING=true)
      operationId: getPerformance
      security: []
      responses:
        '200':
          description: Performance data retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PerformanceResponse'
        '503':
          description: Profiling not enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /metrics/prometheus:
    get:
      tags:
        - Health & Monitoring
      summary: Prometheus metrics
      description: Get Prometheus-formatted metrics
      operationId: getPrometheusMetrics
      security: []
      responses:
        '200':
          description: Prometheus metrics
          content:
            text/plain:
              schema:
                type: string
              example: |
                # HELP http_requests_total Total HTTP requests
                # TYPE http_requests_total counter
                http_requests_total{method="GET",status="200"} 45000

  /admin/cache/clear:
    post:
      tags:
        - Cache Management
      summary: Clear cache
      description: Clear all cached data
      operationId: clearCache
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Cache cleared successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      itemsCleared:
                        type: integer
                      memoryFreed:
                        type: integer
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /admin/cache/stats:
    get:
      tags:
        - Cache Management
      summary: Cache statistics
      description: Get detailed cache statistics
      operationId: getCacheStats
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Cache statistics retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CacheStatsResponse'

  /api/session/create:
    post:
      tags:
        - Session Management
      summary: Create session
      description: Create a new user session
      operationId: createSession
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
              properties:
                userId:
                  type: string
                  description: Unique user identifier
                metadata:
                  type: object
                  description: Additional session metadata
            example:
              userId: user123
              metadata:
                device: desktop
                browser: Chrome
      responses:
        '200':
          description: Session created successfully
          headers:
            Set-Cookie:
              schema:
                type: string
              description: Encrypted session cookie
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      sessionId:
                        type: string
                      expiresAt:
                        type: string
                        format: date-time
                      maxAge:
                        type: integer

  /api/session/destroy:
    delete:
      tags:
        - Session Management
      summary: Destroy session
      description: Destroy current session
      operationId: destroySession
      security:
        - sessionCookie: []
      responses:
        '200':
          description: Session destroyed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /api/session/validate:
    get:
      tags:
        - Session Management
      summary: Validate session
      description: Validate current session
      operationId: validateSession
      security:
        - sessionCookie: []
      responses:
        '200':
          description: Session is valid
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                  sessionId:
                    type: string
                  userId:
                    type: string
                  createdAt:
                    type: string
                    format: date-time
                  expiresAt:
                    type: string
                    format: date-time
                  timeRemaining:
                    type: integer

  /admin/security/blacklist:
    post:
      tags:
        - Security
      summary: Add IP to blacklist
      description: Add IP address to blacklist
      operationId: addToBlacklist
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - ip
              properties:
                ip:
                  type: string
                  format: ipv4
                reason:
                  type: string
                duration:
                  type: integer
                  description: Duration in milliseconds
            example:
              ip: 192.168.1.100
              reason: Suspicious activity
              duration: 3600000
      responses:
        '200':
          description: IP added to blacklist
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      ip:
                        type: string
                      blacklistedAt:
                        type: string
                        format: date-time
                      expiresAt:
                        type: string
                        format: date-time

  /admin/security/blacklist/{ip}:
    delete:
      tags:
        - Security
      summary: Remove IP from blacklist
      description: Remove IP address from blacklist
      operationId: removeFromBlacklist
      security:
        - bearerAuth: []
      parameters:
        - name: ip
          in: path
          required: true
          schema:
            type: string
            format: ipv4
      responses:
        '200':
          description: IP removed from blacklist
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  /admin/audit/logs:
    get:
      tags:
        - Security
      summary: Query audit logs
      description: Query audit logs with filters
      operationId: queryAuditLogs
      security:
        - bearerAuth: []
      parameters:
        - name: category
          in: query
          schema:
            type: string
            enum:
              - security_violation
              - data_access
              - config_change
              - admin_action
              - user_action
        - name: startDate
          in: query
          schema:
            type: string
            format: date-time
        - name: endDate
          in: query
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
        - name: offset
          in: query
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Audit logs retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditLogsResponse'

  /api/ai/summarize:
    post:
      tags:
        - AI Copilot
      summary: Summarize content
      description: Summarize web page content
      operationId: summarizeContent
      security:
        - sessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - content
              properties:
                content:
                  type: string
                  description: Content to summarize
                maxLength:
                  type: integer
                  description: Maximum number of sentences
                  default: 3
            example:
              content: Long web page content...
              maxLength: 3
      responses:
        '200':
          description: Content summarized successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      summary:
                        type: string
                      wordCount:
                        type: integer
                      compressionRatio:
                        type: number

  /api/ai/question:
    post:
      tags:
        - AI Copilot
      summary: Ask question
      description: Ask question about page content
      operationId: askQuestion
      security:
        - sessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - question
                - context
              properties:
                question:
                  type: string
                context:
                  type: string
            example:
              question: What is the main topic?
              context: Page content for context...
      responses:
        '200':
          description: Question answered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      answer:
                        type: string
                      confidence:
                        type: number
                        minimum: 0
                        maximum: 1
                      sources:
                        type: array
                        items:
                          type: string

  /api/privacy/score:
    get:
      tags:
        - Privacy
      summary: Privacy score
      description: Get privacy protection score
      operationId: getPrivacyScore
      security: []
      responses:
        '200':
          description: Privacy score retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PrivacyScoreResponse'

  /api/privacy/statistics:
    get:
      tags:
        - Privacy
      summary: Privacy statistics
      description: Get privacy protection statistics
      operationId: getPrivacyStatistics
      security: []
      responses:
        '200':
          description: Privacy statistics retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  trackersBlocked:
                    type: integer
                  cookiesBlocked:
                    type: integer
                  fingerprintAttemptsBlocked:
                    type: integer
                  canvasRandomizations:
                    type: integer
                  webglRandomizations:
                    type: integer
                  protectionLevel:
                    type: string
                    enum: [minimal, standard, strict]

  /api/vr/capabilities:
    get:
      tags:
        - VR/WebXR
      summary: VR capabilities
      description: Check VR device capabilities
      operationId: getVRCapabilities
      security: []
      responses:
        '200':
          description: VR capabilities retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VRCapabilitiesResponse'

  /api/vr/session/start:
    post:
      tags:
        - VR/WebXR
      summary: Start VR session
      description: Start VR session with specified features
      operationId: startVRSession
      security:
        - sessionCookie: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - sessionMode
              properties:
                sessionMode:
                  type: string
                  enum: [immersive-vr, immersive-ar, inline]
                features:
                  type: array
                  items:
                    type: string
                    enum: [hand-tracking, eye-tracking, layers, depth-sensing]
            example:
              sessionMode: immersive-vr
              features: [hand-tracking, layers]
      responses:
        '200':
          description: VR session started successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    properties:
                      sessionId:
                        type: string
                      mode:
                        type: string
                      targetFrameRate:
                        type: integer
                      features:
                        type: array
                        items:
                          type: string
                      recommendedSettings:
                        type: object
                        properties:
                          foveationLevel:
                            type: integer
                          renderScale:
                            type: number

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Admin API token authentication

    sessionCookie:
      type: apiKey
      in: cookie
      name: session
      description: Encrypted session cookie

  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        timestamp:
          type: string
          format: date-time
        uptime:
          type: integer
          description: Uptime in seconds
        version:
          type: string
        system:
          type: object
          properties:
            memory:
              type: object
              properties:
                used:
                  type: integer
                total:
                  type: integer
                percentage:
                  type: number
            cpu:
              type: object
              properties:
                usage:
                  type: number
                cores:
                  type: integer
            eventLoop:
              type: object
              properties:
                lag:
                  type: number
        dependencies:
          type: object
          additionalProperties:
            type: boolean

    MetricsResponse:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        uptime:
          type: integer
        cache:
          type: object
          properties:
            hits:
              type: integer
            misses:
              type: integer
            hitRate:
              type: number
            size:
              type: integer
            maxSize:
              type: integer
            memoryUsage:
              type: integer
            evictions:
              type: integer
        requests:
          type: object
          properties:
            total:
              type: integer
            rate:
              type: number
            errors:
              type: integer
            errorRate:
              type: number
        sessions:
          type: object
          properties:
            active:
              type: integer
            activeUsers:
              type: integer
            created:
              type: integer
            destroyed:
              type: integer
        security:
          type: object
          properties:
            blockedRequests:
              type: integer
            blacklistedIps:
              type: integer
            rateLimitHits:
              type: integer

    PerformanceResponse:
      type: object
      properties:
        uptime:
          type: integer
        timings:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              count:
                type: integer
              min:
                type: number
              max:
                type: number
              mean:
                type: number
              median:
                type: number
              p95:
                type: number
              p99:
                type: number
              stdDev:
                type: number
        bottlenecks:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              p95:
                type: number
              mean:
                type: number
              count:
                type: integer
              recommendation:
                type: string
        memory:
          type: object
        gc:
          type: object

    CacheStatsResponse:
      type: object
      properties:
        size:
          type: integer
        maxSize:
          type: integer
        memoryUsage:
          type: integer
        hits:
          type: integer
        misses:
          type: integer
        hitRate:
          type: number
        evictions:
          type: integer
        strategy:
          type: string
        ttl:
          type: integer
        items:
          type: array
          items:
            type: object
            properties:
              key:
                type: string
              size:
                type: integer
              accessCount:
                type: integer
              lastAccess:
                type: string
                format: date-time
              expiresAt:
                type: string
                format: date-time

    AuditLogsResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            total:
              type: integer
            limit:
              type: integer
            offset:
              type: integer
            logs:
              type: array
              items:
                type: object
                properties:
                  id:
                    type: string
                  timestamp:
                    type: string
                    format: date-time
                  category:
                    type: string
                  action:
                    type: string
                  userId:
                    type: string
                  ip:
                    type: string
                  metadata:
                    type: object
                  signature:
                    type: string

    PrivacyScoreResponse:
      type: object
      properties:
        score:
          type: integer
          minimum: 0
          maximum: 100
        maxScore:
          type: integer
        grade:
          type: string
          enum: [A+, A, B, C, D, F]
        protections:
          type: object
          properties:
            canvasRandomization:
              type: boolean
            webglRandomization:
              type: boolean
            thirdPartyCookiesBlocked:
              type: boolean
            trackersBlocked:
              type: boolean
            userAgentRandomized:
              type: boolean
        recommendations:
          type: array
          items:
            type: object
            properties:
              issue:
                type: string
              recommendation:
                type: string
              impact:
                type: string
                enum: [Low, Medium, High]

    VRCapabilitiesResponse:
      type: object
      properties:
        webxrSupported:
          type: boolean
        vrSupported:
          type: boolean
        arSupported:
          type: boolean
        features:
          type: object
          properties:
            handTracking:
              type: boolean
            eyeTracking:
              type: boolean
            layers:
              type: boolean
            depthSensing:
              type: boolean
        recommendedSettings:
          type: object
          properties:
            foveationLevel:
              type: integer
            targetFrameRate:
              type: integer
            renderScale:
              type: number

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object
        timestamp:
          type: string
          format: date-time

  responses:
    UnauthorizedError:
      description: Authentication required or invalid
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error:
              code: AUTH_REQUIRED
              message: Authentication required
            timestamp: '2025-10-12T10:00:00.000Z'

    NotFoundError:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    RateLimitError:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
              retryAfter:
                type: integer
              limit:
                type: integer
              window:
                type: integer
