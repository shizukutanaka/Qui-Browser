const DataManager = require('./data-manager');

/**
 * AutoBookmarkManager
 *
 * ユーザーの閲覧行動に基づいて自動的にブックマークを提案・保存するマネージャー
 * - 訪問頻度の高いサイトを自動検出
 * - 長時間滞在したページを提案
 * - ソーシャルメディアの共有リンクを自動保存
 * - 重複ブックマークの自動整理
 */
class AutoBookmarkManager {
  constructor(options = {}) {
    this.dataManager = new DataManager(options);
    this.bookmarksFile = 'bookmarks.json';
    this.historyFile = 'history.json';
    this.settingsFile = 'browser-settings.json';

    // 自動ブックマークの基準設定
    this.autoBookmarkThreshold = {
      visitCount: options.visitCount || 5,      // 訪問回数閾値
      dwellTime: options.dwellTime || 300000,   // 滞在時間（5分）
      socialScore: options.socialScore || 0.7   // ソーシャルスコア
    };

    this.maxAutoBookmarks = options.maxAutoBookmarks || 50;
    this.autoBookmarkPrefix = '[自動] ';
  }

  /**
   * ページ訪問データを分析して自動ブックマーク候補を生成
   */
  async analyzeAndAutoBookmark(visitData) {
    const { url, title, dwellTime, visitCount, referrer } = visitData;

    // 自動ブックマークの条件をチェック
    const shouldAutoBookmark = await this.shouldAutoBookmark({
      url, title, dwellTime, visitCount, referrer
    });

    if (!shouldAutoBookmark) {
      return null;
    }

    // 自動ブックマークを作成
    const bookmark = {
      id: await this.getNextBookmarkId(),
      url,
      title: this.autoBookmarkPrefix + (title || url),
      folder: 'auto-generated',
      tags: await this.generateTags(url, title, referrer),
      createdAt: Date.now(),
      updatedAt: Date.now(),
      autoGenerated: true,
      confidence: this.calculateConfidence(visitData)
    };

    // ブックマークを保存
    await this.addAutoBookmark(bookmark);

    return bookmark;
  }

  /**
   * 自動ブックマークの条件を判定
   */
  async shouldAutoBookmark(visitData) {
    const { url, dwellTime, visitCount } = visitData;

    // 基本的な条件チェック
    if (dwellTime < this.autoBookmarkThreshold.dwellTime) {
      return false;
    }

    if (visitCount < this.autoBookmarkThreshold.visitCount) {
      return false;
    }

    // 既にブックマーク済みかチェック
    const existingBookmarks = await this.dataManager.read(this.bookmarksFile, []);
    const isAlreadyBookmarked = existingBookmarks.some(b => b.url === url);

    if (isAlreadyBookmarked) {
      return false;
    }

    // 自動ブックマーク数の上限チェック
    const autoBookmarks = existingBookmarks.filter(b => b.autoGenerated);
    if (autoBookmarks.length >= this.maxAutoBookmarks) {
      // 最も古い自動ブックマークを削除
      await this.cleanupOldAutoBookmarks();
    }

    return true;
  }

  /**
   * 自動ブックマークを追加
   */
  async addAutoBookmark(bookmark) {
    const bookmarks = await this.dataManager.read(this.bookmarksFile, []);
    bookmarks.push(bookmark);
    await this.dataManager.write(this.bookmarksFile, bookmarks);
  }

  /**
   * 次のブックマークIDを取得
   */
  async getNextBookmarkId() {
    const nextId = await this.dataManager.read('bookmark-next-id.json', 1);
    await this.dataManager.write('bookmark-next-id.json', nextId + 1);
    return nextId;
  }

  /**
   * ページのタグを自動生成
   */
  async generateTags(url, title, referrer) {
    const tags = [];

    // URLベースのタグ生成
    if (url.includes('github.com')) tags.push('開発');
    if (url.includes('stackoverflow.com')) tags.push('プログラミング');
    if (url.includes('youtube.com') || url.includes('youtu.be')) tags.push('動画');
    if (url.includes('twitter.com') || url.includes('x.com')) tags.push('SNS');
    if (url.includes('facebook.com')) tags.push('ソーシャル');
    if (url.includes('linkedin.com')) tags.push('ビジネス');
    if (url.includes('amazon.com') || url.includes('amazon.co.jp')) tags.push('ショッピング');
    if (url.includes('news')) tags.push('ニュース');

    // タイトルベースのタグ生成
    const titleLower = (title || '').toLowerCase();
    if (titleLower.includes('tutorial') || titleLower.includes('ガイド')) tags.push('学習');
    if (titleLower.includes('blog') || titleLower.includes('記事')) tags.push('記事');
    if (titleLower.includes('document') || titleLower.includes('docs')) tags.push('ドキュメント');

    // リファラーベースのタグ生成
    if (referrer) {
      if (referrer.includes('google.com')) tags.push('検索');
      if (referrer.includes('github.com')) tags.push('開発');
    }

    return [...new Set(tags)]; // 重複除去
  }

  /**
   * ブックマークの信頼度を計算
   */
  calculateConfidence(visitData) {
    const { dwellTime, visitCount } = visitData;

    // 滞在時間スコア（最大1.0）
    const dwellScore = Math.min(dwellTime / (30 * 60 * 1000), 1.0); // 30分で最大

    // 訪問回数スコア（最大1.0）
    const visitScore = Math.min(visitCount / 20, 1.0); // 20回で最大

    // 総合スコア
    return (dwellScore * 0.6) + (visitScore * 0.4);
  }

  /**
   * 古い自動ブックマークを整理
   */
  async cleanupOldAutoBookmarks() {
    const bookmarks = await this.dataManager.read(this.bookmarksFile, []);
    const autoBookmarks = bookmarks.filter(b => b.autoGenerated);

    // 信頼度が低い順にソート
    autoBookmarks.sort((a, b) => a.confidence - b.confidence);

    // 最も信頼度が低いものを削除
    const toRemove = autoBookmarks.slice(0, Math.max(1, autoBookmarks.length - this.maxAutoBookmarks + 1));
    const remainingBookmarks = bookmarks.filter(b => !toRemove.includes(b));

    await this.dataManager.write(this.bookmarksFile, remainingBookmarks);
  }

  /**
   * 重複ブックマークの自動整理
   */
  async deduplicateBookmarks() {
    const bookmarks = await this.dataManager.read(this.bookmarksFile, []);
    const seen = new Map();
    const deduplicated = [];

    for (const bookmark of bookmarks) {
      const key = bookmark.url.toLowerCase();
      if (!seen.has(key)) {
        seen.set(key, bookmark);
        deduplicated.push(bookmark);
      } else {
        // より新しいものを優先
        const existing = seen.get(key);
        if (bookmark.updatedAt > existing.updatedAt) {
          seen.set(key, bookmark);
        }
      }
    }

    // Mapから配列に変換
    const finalBookmarks = Array.from(seen.values());

    await this.dataManager.write(this.bookmarksFile, finalBookmarks);

    return finalBookmarks.length;
  }

  /**
   * 自動ブックマーク設定の取得
   */
  async getSettings() {
    const settings = await this.dataManager.read(this.settingsFile, {});
    return {
      autoBookmarkEnabled: settings.autoBookmarkEnabled ?? true,
      visitCountThreshold: settings.visitCountThreshold ?? this.autoBookmarkThreshold.visitCount,
      dwellTimeThreshold: settings.dwellTimeThreshold ?? this.autoBookmarkThreshold.dwellTime,
      maxAutoBookmarks: settings.maxAutoBookmarks ?? this.maxAutoBookmarks
    };
  }

  /**
   * 自動ブックマーク設定の更新
   */
  async updateSettings(newSettings) {
    const currentSettings = await this.dataManager.read(this.settingsFile, {});
    const updatedSettings = { ...currentSettings, ...newSettings };
    await this.dataManager.write(this.settingsFile, updatedSettings);

    // 設定を反映
    this.autoBookmarkThreshold.visitCount = updatedSettings.visitCountThreshold;
    this.autoBookmarkThreshold.dwellTime = updatedSettings.dwellTimeThreshold;
    this.maxAutoBookmarks = updatedSettings.maxAutoBookmarks;
  }
}

module.exports = AutoBookmarkManager;
